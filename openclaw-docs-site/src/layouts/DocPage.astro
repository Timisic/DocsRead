---
// src/layouts/DocPage.astro
import DocsLayout from './DocsLayout.astro';
import DocsSidebar from '../components/DocsSidebar.astro';

const { title, description } = Astro.props;
const currentPath = Astro.url.pathname;
---

<DocsLayout title={title} description={description}>
  <div class="docs-shell">
    <!-- Desktop sidebar -->
    <div class="fixed left-0 top-0 z-10 hidden h-full md:block">
      <DocsSidebar currentPath={currentPath} />
    </div>

    <!-- Mobile sidebar toggle -->
    <div class="mobile-topbar fixed left-0 right-0 top-0 z-30 md:hidden">
      <div class="flex items-center justify-between p-4">
        <h1 class="text-base font-semibold tracking-wide">OpenClaw 使用指南</h1>
        <button id="mobile-menu-toggle" class="rounded-md p-2 hover:bg-slate-100/80" type="button" aria-label="打开侧边栏">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile sidebar -->
    <div id="mobile-sidebar" class="mobile-sidebar fixed inset-y-0 left-0 z-40 w-64 -translate-x-full transform transition-transform duration-300 ease-in-out md:hidden">
      <div class="border-b p-4" style="border-color: var(--border);">
        <button id="mobile-menu-close" class="rounded-md p-2 hover:bg-slate-100/80" type="button" aria-label="关闭侧边栏">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <DocsSidebar currentPath={currentPath} />
    </div>

    <!-- Mobile overlay -->
    <div id="mobile-overlay" class="mobile-overlay fixed inset-0 z-20 hidden md:hidden"></div>

    <!-- Main content -->
    <main class="docs-main">
      <article class="docs-main-inner app-prose">
        <slot />
      </article>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileMenuClose = document.getElementById('mobile-menu-close');
      const mobileSidebar = document.getElementById('mobile-sidebar');
      const mobileOverlay = document.getElementById('mobile-overlay');

      const openMenu = () => {
        mobileSidebar?.classList.remove('-translate-x-full');
        mobileOverlay?.classList.remove('hidden');
      };

      const closeMenu = () => {
        mobileSidebar?.classList.add('-translate-x-full');
        mobileOverlay?.classList.add('hidden');
      };

      mobileMenuToggle?.addEventListener('click', openMenu);
      mobileMenuClose?.addEventListener('click', closeMenu);
      mobileOverlay?.addEventListener('click', closeMenu);
      document.addEventListener('keydown', event => {
        if (event.key === 'Escape') closeMenu();
      });

      const proseRoot = document.querySelector('.app-prose');
      if (proseRoot) {
        const headings = proseRoot.querySelectorAll('h2, h3, h4, h5, h6');
        headings.forEach(heading => {
          if (!(heading instanceof HTMLElement) || !heading.id) return;
          if (heading.querySelector('.heading-link')) return;

          const link = document.createElement('a');
          link.className = 'heading-link';
          link.href = `#${heading.id}`;
          link.setAttribute('aria-label', `复制标题链接: ${heading.textContent ?? ''}`);
          link.textContent = '#';
          heading.appendChild(link);
        });
      }

      document.querySelectorAll('.code-block').forEach(block => {
        const copyBtn = block.querySelector('.copy-btn');
        const pre = block.querySelector('pre');
        if (!copyBtn || !pre) return;

        copyBtn.addEventListener('click', async event => {
          event.preventDefault();
          event.stopPropagation();

          const lineSelector = '.line, [data-line]';
          const lines = pre.querySelectorAll(lineSelector);
          const codeText = lines.length > 0
            ? Array.from(lines).map(line => line.textContent ?? '').join('\n').trimEnd()
            : (pre.querySelector('code')?.textContent ?? pre.textContent ?? '').trim();

          try {
            await navigator.clipboard.writeText(codeText);
          } catch {
            const textarea = document.createElement('textarea');
            textarea.value = codeText;
            textarea.style.cssText = 'position: fixed; left: -9999px;';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }

          copyBtn.classList.add('copied');
          setTimeout(() => copyBtn.classList.remove('copied'), 1500);
        });
      });
    });
  </script>
</DocsLayout>
