---
// src/components/CodeBlock.astro
// This component will be injected via rehype-pretty-code to add copy buttons
---

<style>
  .code-wrapper {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    background-color: #f6f8fa;
    border: 1px solid #d0d7de;
    border-bottom: none;
    border-radius: 0.5rem 0.5rem 0 0;
  }

  .language-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #57606a;
    text-transform: uppercase;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
  }

  .copy-button {
    background-color: transparent;
    border: 1px solid #d0d7de;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    color: #57606a;
    transition: all 0.15s ease;
    font-family: inherit;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .copy-button:hover {
    background-color: #f6f8fa;
    color: #24292f;
  }

  .copy-button.copied {
    background-color: #daeaec;
    color: #0969da;
    border-color: #0969da;
  }

  .copy-button svg {
    width: 14px;
    height: 14px;
  }
</style>

<script>
  // Add copy button to all code blocks
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('pre[data-language]');

    codeBlocks.forEach((pre) => {
      const language = pre.getAttribute('data-language') || 'plaintext';
      const code = pre.querySelector('code');

      if (!code) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';

      const header = document.createElement('div');
      header.className = 'code-header';

      const languageLabel = document.createElement('span');
      languageLabel.className = 'language-label';
      languageLabel.textContent = language;

      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.type = 'button';
      copyButton.setAttribute('aria-label', 'Copy code to clipboard');
      copyButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <span>Copy</span>
      `;

      copyButton.addEventListener('click', async () => {
        const codeText = code.textContent || '';

        try {
          if (navigator.clipboard) {
            await navigator.clipboard.writeText(codeText);
            updateButtonState(copyButton, true);
          } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            updateButtonState(copyButton, true);
          }
        } catch (err) {
          console.error('复制失败:', err);
          updateButtonState(copyButton, false);
        }
      });

      header.appendChild(languageLabel);
      header.appendChild(copyButton);

      // Wrap the pre element
      pre.parentNode.insertBefore(wrapper, pre);
      wrapper.appendChild(header);
      wrapper.appendChild(pre);

      // Fix border radius for pre element
      pre.style.borderRadius = '0 0 0.5rem 0.5rem';
    });

    function updateButtonState(button, success) {
      const span = button.querySelector('span');

      if (success) {
        span.textContent = 'Copied';
        button.classList.add('copied');
      } else {
        span.textContent = 'Failed';
        button.classList.add('copied');
      }

      setTimeout(() => {
        span.textContent = 'Copy';
        button.classList.remove('copied');
      }, 2000);
    }
  });
</script>